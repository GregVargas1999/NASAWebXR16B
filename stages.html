<!DOCTYPE html>
<html>

<head>
    <base href="./">
    <meta charset="utf-8">
    <title>psyche_asteroid</title>
    <link rel="stylesheet" href="css/stages-style.css">
</head>

<body>
    <div id='card'>
        <div id='info' class="ml2">The Psyche Asteroid Mission
        </div>
        <button class="button" id='beginButton'>Begin Journey</button>
        <div>
            <button class="button" id='prevButton' style='visibility: hidden;'>Previous Stage</button>
            <button class="button" id='nextButton' style='visibility: hidden;'>Next Stage</button>
        </div>

        <div id='descriptionBox'>
            <div id='description'></div>
            <div id='details'></div>
            <button id='moreInfo' class="tooltip" alignment='center'>&#8505 More info
        </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script type='module'>

        import * as THREE from 'https://unpkg.com/three@0.124.0/build/three.module.js';
        import { Vector3 } from 'https://unpkg.com/three@0.125.2/src/math/Vector3.js';
        import { Raycaster } from 'https://unpkg.com/three@0.125.2/src/core/Raycaster.js';
        import { GLTFLoader } from 'https://unpkg.com/three@0.125.2/examples/jsm/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'https://unpkg.com/three@0.125.2/examples/jsm/loaders/DRACOLoader.js';

        import TWEEN from 'https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.5.0/dist/tween.esm.js';

        var container, controls;
        var camera, povCamera, scene, renderer, tween;
        var raycaster, projector, mouseVector, intersects, intersection, obj;
        var asteroid, satellite, asteroid2, satellite2, mars, orbiter, newMin;
        var targetPosition = new THREE.Vector3();
        var position = new THREE.Vector3();
        var beginButton, nextButton, prevButton, infoText, moreInfo, canvasCard, description, details, descriptionBox;
        var set2Idle = true;
        const params = {
            orbitDistance: 5,
            orbitSpeed: 1,
            orbitTiltX: 0,
            orbitTiltY: 0,
            orbitTiltZ: 0,
            cameraFOV: 45
        };
        var tween, orbit, orbitContainer;
        var rotSpeed = 0.0001;
        var rotSpeed2 = 0.002;

        init();
        animate();

        function init() {
            canvasCard = document.getElementById('card');
            infoText = document.getElementById('info');
            beginButton = document.getElementById('beginButton');
            prevButton = document.getElementById('prevButton');
            nextButton = document.getElementById('nextButton');
            description = document.getElementById('description');
            descriptionBox = document.getElementById('descriptionBox');
            details = document.getElementById('details');
            moreInfo = document.getElementById('moreInfo');
            beginButton.addEventListener('click', marsAssist, false);
            beginButton.addEventListener('touchend', marsAssist, false);
            moreInfo.addEventListener('click', showDetails, false);
            moreInfo.addEventListener('touchend', showDetails, false);
            orbitContainer = new THREE.Object3D();

            container = document.createElement('div');
            document.body.appendChild(container);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 100000);
            camera.position.set(-297, 0, 22);
            position.copy(camera.position)
            camera.lookAt(new THREE.Vector3(-297, 0, 0));

            scene = new THREE.Scene();

            //scene.add(new THREE.HemisphereLight(0xFFFFFF, 0xFFFFFF, 0.5));
            // This creates a soft light so that shadows are less harsh
            var ambientLight = new THREE.AmbientLight(0xFFFFFF, 0.1);
            scene.add(ambientLight);

            // Point light is similar to directional light, I'm using realistic setting for light falloff
            // PointLight( color : Integer, intensity : Float, distance : Number, decay : Float )
            var pointLight = new THREE.PointLight(0xFFFFFF, 1, 0, 1);
            pointLight.position.set(-7000, 2000, -10000);
            scene.add(pointLight);

            // Build sphere mesh
            // SphereGeometry(radius : Float, widthSegments : Integer, heightSegments : Integer)
            var geometry = new THREE.SphereGeometry(20, 30, 30);
            var material = new THREE.MeshLambertMaterial(
                {
                    color: 0xFC9601,
                    emissive: 0xFC9601,
                    emissiveIntensity: 1000
                });
            var mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(-7000, 2000, -10000);
            scene.add(mesh);

            // Build glow effect
            // Using png sprite blending
            var spriteMaterial = new THREE.SpriteMaterial(
                {
                    map: new THREE.TextureLoader().load('textures/orange glow.png'),
                    color: 0xFFCC33,
                    transparent: true,
                    blending: THREE.AdditiveBlending
                });
            var sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(200, 200, 1.0);
            mesh.add(sprite); // this centers the glow at the mesh

            var particleGeom = new THREE.Geometry();
            var particleMaterial = new THREE.PointsMaterial({
                color: 'rgb(80, 130, 255)',
                size: 50,
                map: new THREE.TextureLoader().load('textures/lensflare0.png'),
                transparent: true,
                blending: THREE.AdditiveBlending,
            });

            // Plotting particles at -(min to max) and (min to max)
            let particleCount = 5000;
            let min = 100;
            let max = 10000;

            for (var i = 0; i < particleCount; i++) {
                let posX = (getRandom(min) * (2 * (max - min))) + newMin;
                let posY = (getRandom(min) * (2 * (max - min))) + newMin;
                let posZ = (getRandom(min) * (2 * (max - min))) + newMin;

                let particle = new THREE.Vector3(posX, posY, posZ);
                particleGeom.vertices.push(particle);
            }

            let particleSys = new THREE.Points(particleGeom, particleMaterial);
            particleSys.name = 'particleSys';
            scene.add(particleSys);

            var loader = new GLTFLoader().setPath('models/');
            var dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('js/draco/');
            loader.setDRACOLoader(dracoLoader);
            loader.load('compressed-spacecraft.glb', function (gltf) {
                satellite = gltf.scene;
                satellite.scale.set(0.01, 0.01, 0.01);
                satellite.position.set(-296, 0, 18);
                scene.add(satellite);
                animate();
            });
            loader.load('mars-compressed.glb', function (gltf) {
                mars = gltf.scene;
                mars.scale.set(0.01, 0.01, 0.01);
                mars.position.set(-200, 0, -50);
                scene.add(mars);
                animate();
            });
            loader.load('asteroid-compressed.glb', function (gltf) {
                asteroid = gltf.scene;
                asteroid.scale.set(2, 2, 2);
                asteroid.position.set(-100, 0, -50);
                asteroid.rotation.y += 25;
                scene.add(asteroid);
                animate();
            });

            loader.load('compressed-spacecraft.glb', function (gltf) {
                orbiter = gltf.scene;
                orbiter.scale.set(0.0025, 0.0025, 0.0025);
                orbiter.rotation.z = 180;
                orbiter.rotation.y = 45;
                scene.add(orbiter);
                orbitAnimation(orbiter, params.orbitDistance, params.orbitTiltX, params.orbitTiltY, params.orbitTiltZ, params.orbitSpeed);
            });

            loader.load('compressed-spacecraft.glb', function (gltf) {
                satellite2 = gltf.scene;
                satellite2.scale.set(0.01, 0.01, 0.01);
                satellite2.position.set(-596, 0, 18);
                scene.add(satellite2);
                animate();
            });
            loader.load('asteroid-compressed.glb', function (gltf) {
                asteroid2 = gltf.scene;
                asteroid2.scale.set(2, 2, 2);
                asteroid2.position.set(-500, 0, -50);
                asteroid2.rotation.y += 25;
                scene.add(asteroid2);
                animate();
            });

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1;
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);

            var pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();

            mouseVector = new THREE.Vector3();

            textAnimate();
        }

        function showDetails() {
            description.style.display = "none";
            details.style.display = "block";
            moreInfo.innerHTML = "Close";
            moreInfo.removeEventListener('click', showDetails, false);
            moreInfo.removeEventListener('touchend', showDetails, false);
            moreInfo.addEventListener('click', closeDetails, false);
            moreInfo.addEventListener('touchend', closeDetails, false);
            descriptionBox.style.margintop = "20%";
            descriptionBox.style.marginleft = "55%";
            descriptionBox.style.width = "55%";
        }

        function closeDetails() {
            description.style.display = "block";
            details.style.display = "none";
            moreInfo.innerHTML = "&#8505 More info"
            moreInfo.removeEventListener('click', closeDetails, false);
            moreInfo.removeEventListener('touchend', closeDetails, false);
            moreInfo.addEventListener('click', showDetails, false);
            moreInfo.addEventListener('touchend', showDetails, false);
            descriptionBox.style.margintop = "30%";
            descriptionBox.style.marginleft = "65%";
            descriptionBox.style.width = "45%";
        }

        function getRandom(number) {
            let rand = (Math.random() - 0.5);
            newMin = number;

            if (rand < 0) {
                newMin *= -1;
            }

            return rand;
        }

        function marsAssist() {

            canvasCard.style.display = "none";
            if (set2Idle) {
                satellite2.position.set(-200, -1, 10);
                set2Idle = false;
            }
            else {
                satellite.position.set(-200, -1, 10);
                set2Idle = true;
            }

            targetPosition.x = -197;
            targetPosition.y = 0;
            targetPosition.z = 22;

            tween = new TWEEN.Tween(position)
                .to(targetPosition, 2500)
                .easing(TWEEN.Easing.Sinusoidal.InOut)
                .onUpdate(function () {
                    camera.position.copy(position);
                })
                .onComplete(function () {
                    infoText.innerHTML = "Phase #1 - Mars Gravity Assist";
                    textAnimate();
                    beginButton.style.visibility = "hidden";
                    prevButton.style.visibility = "hidden";
                    nextButton.style.visibility = "visible";
                    description.innerHTML = "After launching in August 2022, the spacecraft " +
                        "flies by Mars and undergoes a gravitational slingshot";
                    details.innerHTML = "More detailed description goes here -->\n" +
                        "####################\n####################\n" +
                        "####################\n####################\n" +
                        "####################\n####################\n" +
                        "####################\n####################\n";
                    canvasCard.style.display = "block";
                    prevButton.removeEventListener('click', marsAssist, false);
                    nextButton.addEventListener('click', arrivalPhase, false);
                    descriptionBox.style.visibility = "visible";
                    prevButton.removeEventListener('touchend', marsAssist, false);
                    nextButton.addEventListener('touchend', arrivalPhase, false);
                    closeDetails();
                })
                .start();

        }

        function arrivalPhase() {

            canvasCard.style.display = "none";

            if (set2Idle) {
                satellite2.position.set(-100, 0, 12);
                asteroid2.position.set(-100, 0, -50);
                set2Idle = false;
            }
            else {
                satellite.position.set(-100, 0, 12);
                asteroid.position.set(-100, 0, -50);
                set2Idle = true;
            }

            targetPosition.x = -97;
            targetPosition.y = 0;
            targetPosition.z = 22;

            tween = new TWEEN.Tween(position)
                .to(targetPosition, 2500)
                .easing(TWEEN.Easing.Sinusoidal.InOut)
                .onUpdate(function () {
                    camera.position.copy(position);
                })
                .onComplete(function () {
                    infoText.innerHTML = "Phase #2 - Arrival at Psyche"
                    textAnimate();
                    beginButton.style.visibility = "hidden";
                    prevButton.style.visibility = "visible";
                    nextButton.style.visibility = "visible";
                    description.innerHTML = "After spending around 100 days in the approach phase, " +
                        "the spacecraft begins to orbit the Psyche asteroid in January 2026";
                    canvasCard.style.display = "block";

                    prevButton.removeEventListener('click', arrivalPhase, false);
                    nextButton.removeEventListener('click', arrivalPhase, false);

                    prevButton.removeEventListener('touchend', arrivalPhase, false);
                    nextButton.removeEventListener('touchend', arrivalPhase, false);

                    prevButton.addEventListener('click', marsAssist, false);
                    nextButton.addEventListener('click', orbitalPhase, false);

                    prevButton.addEventListener('touchend', marsAssist, false);
                    nextButton.addEventListener('touchend', orbitalPhase, false);
                    closeDetails();
                })
                .start();
        }

        function orbitalPhase() {

            canvasCard.style.display = "none";

            if (set2Idle) {
                asteroid2.position.set(0, 0, 0);
                set2Idle = false;
            }
            else {
                asteroid.position.set(0, 0, 0);
                set2Idle = true;
            }

            targetPosition.x = 5;
            targetPosition.y = 0;
            targetPosition.z = 22;

            tween = new TWEEN.Tween(position)
                .to(targetPosition, 2500)
                .easing(TWEEN.Easing.Sinusoidal.InOut)
                .onUpdate(function () {
                    camera.position.copy(position);
                })
                .onComplete(function () {
                    infoText.innerHTML = "Phase #3 - Orbiting Psyche"
                    textAnimate();
                    prevButton.addEventListener('click', arrivalPhase, false);
                    nextButton.removeEventListener('click', orbitalPhase, false);
                    prevButton.style.visibility = "visible";
                    nextButton.style.visibility = "hidden";

                    prevButton.addEventListener('touchend', arrivalPhase, false);
                    nextButton.removeEventListener('touchend', orbitalPhase, false);

                    description.innerHTML = "The spacecraft will orbit Psyche until Octbber 2027 (21 months!)," +
                        " where it will take measurements and send data back to Earth";
                    canvasCard.style.display = "block";
                    closeDetails();
                })
                .start();
        }


        function textAnimate() { // Wrap every letter in a span
            var textWrapper = document.querySelector('.ml2');
            textWrapper.innerHTML = textWrapper.textContent.replace(/\S/g, "<span class='letter'>$&</span>");

            anime.timeline({ loop: false })
                .add({
                    targets: '.ml2 .letter',
                    scale: [4, 1],
                    opacity: [0, 1],
                    translateZ: 0,
                    easing: "easeOutExpo",
                    duration: 950,
                    delay: (el, i) => 70 * i
                });
        }

        function orbitAnimation(objectToMod, distance, xTilt, yTilt, zTilt, speed) {
            orbitContainer.rotation.x = xTilt;
            orbitContainer.rotation.y = yTilt;
            orbitContainer.rotation.z = zTilt;

            orbit = new THREE.Object3D();

            var planet = objectToMod;
            planet.position.set(distance, 0, 0.0);
            orbit.add(planet);

            tween = new TWEEN.Tween(orbit.rotation).to({ z: '+' + (Math.PI * 2) }, 10000 / speed);

            tween.start();
            tween.repeat(Infinity);

            orbitContainer.add(orbit);
            scene.add(orbitContainer);
            return orbitContainer;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);

            animate();
        }

        function animate(time) {
            TWEEN.update(time);
            requestAnimationFrame(animate);

            if (asteroid !== undefined) {

                asteroid.rotation.z += rotSpeed;
                asteroid.rotation.y += rotSpeed;
            }
            if (asteroid2 !== undefined) {
                asteroid2.rotation.z += rotSpeed;
                asteroid2.rotation.y += rotSpeed;
            }

            if (satellite !== undefined) {
                satellite.rotation.x += rotSpeed2;
                satellite.rotation.z += rotSpeed2;
            }

            if (satellite2 !== undefined) {
                satellite2.rotation.x += rotSpeed2;
                satellite2.rotation.z += rotSpeed2;
            }

            if (orbiter !== undefined) {

                orbiter.rotation.x -= rotSpeed2;
                orbiter.rotation.z += rotSpeed2;
            }
            renderer.render(scene, camera);

        }

    </script>
</body>

</html>